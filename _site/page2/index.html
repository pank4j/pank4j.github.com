<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      CodePwn &middot; Stuff about Security
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/pic.png">
                                 <link rel="shortcut icon" href="/public/pic.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <link rel="stylesheet" href="/public/css/highlight/styles/monokai.css">
  <script src="/public/css/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          CodePwn
        </a>
      </h1>
      <p class="lead">Stuff about Security</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive.html">Archive</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/pank4j">GitHub</a>
    </nav>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/dirty-harry-hacking-for-free-drinks-in-singapore">
        Dirty Harry: Hacking for free drinks in Singapore
      </a>
    </h1>

    <span class="post-date">04 Nov 2013</span>

    <p><a href="http://harrys.com.sg/">Harry&#39;s bar</a> is one of the most popular bar chains in Singapore. It has an iOS app &quot;Appy Hour&quot; that lets users spin the Harry&#39;s &quot;wheel of fortune&quot; to win free drinks. The way it works is that a user would visit one of their strategically located bars and check in using the app. He would then spin the wheel, and if he is lucky, he would win a free drink. A time limit is imposed so that a user can spin the wheel only once in 24 hours while signed in a particular bar.</p>

<p>Now there may not be any such thing as a free lunch, but there are free drinks! Let&#39;s see how.</p>

<p><center><img src="/public/images/win240x360.png" /></center>
<p></p></p>

<h2>The &#39;luck factor&#39;</h2>

<p>The app communicates with <code>www.exhost.se</code> over HTTP. When started, the first thing the app does is to define the &quot;luck factor&quot; of the user, by downloading an XML file containing probabilities of various prizes. The probabilities are set in way such that 52% of the time a spin would yield &#39;Better Luck Next Time&#39;.</p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/harrys_1_1_beta/venues.xml</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">www.exhost.se</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Appy Hour 1.1.0 (iPhone; iPhone OS 6.0.1; en_SG)</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip</span>

HTTP/1.1 200 OK
Age: 1659
Connection: Keep-Alive
Content-Length: 3071
Content-Type: application/xml
Date: Fri, 01 Nov 2013 06:27:45 GMT
ETag: &quot;3c8066-bff-4d7ddfaa98300&quot;
Last-Modified: Thu, 14 Mar 2013 08:05:00 GMT
Server: Apache/2.2.22 (Unix) mod_ssl/2.2.22 OpenSSL/0.9.8e-fips-rhel5 DAV/2 mod_bwlimited/1.4 mod_fcgid/2.3.6
Via: 1.1 qt-mfc4:80
 
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;Prizes&gt;
&lt;Prize&gt;
&lt;Description&gt;Better Luck*Next Time&lt;/Description&gt;
&lt;Units&gt;1&lt;/Units&gt;
&lt;ID&gt;1&lt;/ID&gt;
&lt;Active&gt;1&lt;/Active&gt;
&lt;Possibility&gt;13&lt;/Possibility&gt;
&lt;IsPrize&gt;0&lt;/IsPrize&gt;
&lt;PrizeFile&gt;img/1.png&lt;/PrizeFile&gt;
&lt;/Prize&gt;
&lt;Prize&gt;
&lt;Description&gt;1-for-1 Bacardi*Sup Gls&lt;/Description&gt;
&lt;Units&gt;1&lt;/Units&gt;
&lt;ID&gt;2&lt;/ID&gt;
&lt;Active&gt;1&lt;/Active&gt;
&lt;Possibility&gt;5&lt;/Possibility&gt;
&lt;IsPrize&gt;1&lt;/IsPrize&gt;
&lt;PrizeFile&gt;img/2.png&lt;/PrizeFile&gt;
&lt;/Prize&gt;
--snipped--</code></pre></div>

<h2>Time Restriction</h2>

<p>Once the user has checked in the bar, the app checks if the user has already tried his luck in the past 24 hours in the same bar. It does so by sending a request with the iPhone&#39;s UDID, a timestamp and the bar&#39;s id. The response simply consists of <code>true</code> if the user is allowed to spin the wheel, or <code>false</code> otherwise.</p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/harrys_1_1_beta/fetchdata.php?udid=aba5372762118af8f6f0594f836cd0eb32d10986&amp;time=2013-01-11%02:56:15&amp;venue=30</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">www.exhost.se</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Appy Hour 1.1.0 (iPhone; iPhone OS 6.0.1; en_SG)</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip</span>

HTTP/1.1 200 OK
Date: Fri, 01 Nov 2013 06:56:16 GMT
Server: Apache/2.2.22 (Unix) mod_ssl/2.2.22 OpenSSL/0.9.8e-fips-rhel5 DAV/2 mod_bwlimited/1.4 mod_fcgid/2.3.6
X-Powered-By: PHP/5.3.10
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Transfer-Encoding: chunked
Content-Type: text/html

true</code></pre></div>

<h2>Getting past everything</h2>

<p>Well, the simplest way to get past everything would be to make the app communicate with another server instead of <code>www.exhost.se</code>. First we will crawl <code>www.exhost.se</code> to get all the required files. The link <code>http://www.exhost.se/harrys_1_1_beta/</code> does not contain a default <code>index.html</code> or similar file, which makes crawling possible.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>wget -nv -r --no-parent --reject <span class="s2">&quot;index.html*&quot;</span> http://www.exhost.se/harrys_1_1_beta/

2013-11-03 23:37:09 URL:http://www.exhost.se/harrys_1_1_beta/ <span class="o">[</span>639/639<span class="o">]</span> -&gt; /<span class="s2">&quot;www.exhost.se/harrys_1_1_beta/index.html&quot;</span> <span class="o">[</span>1<span class="o">]</span> 
http://www.exhost.se/robots.txt:
2013-11-03 23:37:09 ERROR 404: Not Found.
2013-11-03 23:37:10 URL:http://www.exhost.se/harrys_1_1_beta/cms.php <span class="o">[</span>169<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/cms.php&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:10 URL:http://www.exhost.se/harrys_1_1_beta/connect.php <span class="o">[</span>0/0<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/connect.php&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:10 URL:http://www.exhost.se/harrys_1_1_beta/fetchdata.php <span class="o">[</span>5<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/fetchdata.php&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:11 URL:http://www.exhost.se/harrys_1_1_beta/img/ <span class="o">[</span>1037/1037<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/index.html&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:11 URL:http://www.exhost.se/harrys_1_1_beta/js/ <span class="o">[</span>461/461<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/js/index.html&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:12 URL:http://www.exhost.se/harrys_1_1_beta/venues.xml <span class="o">[</span>3071/3071<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/venues.xml&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:19 URL:http://www.exhost.se/harrys_1_1_beta/img/1.png <span class="o">[</span>50769/50769<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/1.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:23 URL:http://www.exhost.se/harrys_1_1_beta/img/10.png <span class="o">[</span>62543/62543<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/10.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:24 URL:http://www.exhost.se/harrys_1_1_beta/img/11.png <span class="o">[</span>23376/23376<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/11.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:26 URL:http://www.exhost.se/harrys_1_1_beta/img/12.png <span class="o">[</span>33471/33471<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/12.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:29 URL:http://www.exhost.se/harrys_1_1_beta/img/13.png <span class="o">[</span>58419/58419<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/13.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:31 URL:http://www.exhost.se/harrys_1_1_beta/img/14.png <span class="o">[</span>50769/50769<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/14.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:32 URL:http://www.exhost.se/harrys_1_1_beta/img/15.png <span class="o">[</span>50119/50119<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/15.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:33 URL:http://www.exhost.se/harrys_1_1_beta/img/16.png <span class="o">[</span>23376/23376<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/16.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:34 URL:http://www.exhost.se/harrys_1_1_beta/img/2.png <span class="o">[</span>44208/44208<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/2.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:36 URL:http://www.exhost.se/harrys_1_1_beta/img/3.png <span class="o">[</span>62543/62543<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/3.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:38 URL:http://www.exhost.se/harrys_1_1_beta/img/4.png <span class="o">[</span>50769/50769<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/4.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:40 URL:http://www.exhost.se/harrys_1_1_beta/img/5.png <span class="o">[</span>60030/60030<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/5.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:44 URL:http://www.exhost.se/harrys_1_1_beta/img/6.jpg <span class="o">[</span>124823/124823<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/6.jpg&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:46 URL:http://www.exhost.se/harrys_1_1_beta/img/6.png <span class="o">[</span>50119/50119<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/6.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:47 URL:http://www.exhost.se/harrys_1_1_beta/img/7.png <span class="o">[</span>45129/45129<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/7.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:49 URL:http://www.exhost.se/harrys_1_1_beta/img/8.png <span class="o">[</span>50769/50769<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/8.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:50 URL:http://www.exhost.se/harrys_1_1_beta/img/9.png <span class="o">[</span>40394/40394<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/img/9.png&quot;</span> <span class="o">[</span>1<span class="o">]</span>
2013-11-03 23:37:52 URL:http://www.exhost.se/harrys_1_1_beta/js/jquery.min.js <span class="o">[</span>85925/85925<span class="o">]</span> -&gt; <span class="s2">&quot;www.exhost.se/harrys_1_1_beta/js/jquery.min.js&quot;</span> <span class="o">[</span>1<span class="o">]</span>
FINISHED --2013-11-03 23:37:52--
Total wall clock <span class="nb">time</span>: 54s
Downloaded: <span class="m">25</span> files, 950K in 34s <span class="o">(</span>28.1 KB/s<span class="o">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">iPhone:~ root# strings -o /var/mobile/Applications/0B57A351-CE6D-4B05-A5D0-8B12BB150791/Harrys.app/Harrys <span class="p">|</span> grep <span class="s2">&quot;http://www.exhost.se&quot;</span>
<span class="m">839501</span> http://www.exhost.se/harrys_1_1_beta/
<span class="m">842849</span> http://www.exhost.se/harrys_1_1_beta/venues.xml
<span class="m">843075</span> http://www.exhost.se/harrys_1_1_beta/fetchdata.php</code></pre></div>

<p>Once we have the crawled files, we can edit the <code>venues.xml</code> file to change the probabilities. We can even change the drinks! ;-) Also, the file <code>fetchdata.php</code> should contain <code>true</code> for us to spin any number of times. Now these files can be hosted on a different server and these URLs can be changed in the app mach-o binary. Changing only the above two URLs is sufficient to make it work without any restrictions. The strings utility comes handy when trying to find out the location of these strings in the binary. These strings can now be edited using a hex editor. </p>

<p><img src="/public/images/strings.png" alt="Strings as seen in the disassembler after modification"></p>

<p>Once edited, we can run the app any number of times while signed in the same bar, and win a drink on every spin!</p>

<p>Cheers!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/assembling-from-scratch-encoding-blx-instruction-in-arm-thumb">
        Assembling from scratch: Encoding BLX instruction in ARM / THUMB
      </a>
    </h1>

    <span class="post-date">19 Oct 2013</span>

    <p><center><img src="/public/images/blx.png" /></center></p>

<p>If you have been working on x86 disassembly and moving on to ARM disassembly, one of the subtle differences you may notice is the lack of byte aligned opcodes in ARM (or THUMB) instruction set. Being based on RISC, ARM architecture provides fewer instructions as compared to x86. The need to implement an instruction set having functionally similar instructions as their x86 counterparts, only using fewer (and perhaps smaller) instructions gave rise to the instructions where opcodes are not dictated by bytes but by bits.</p>

<p>One of such intriguing instructions in ARM is BLX. BLX instruction performs a PC relative unconditional branch, and optionally changes mode to ARM or THUMB depending on the target address. It encodes to a 32-bit word under THUMB mode 2. It&#39;s encoding varies depending upon the relative offset between the instruction and the target address. For e.g. the instruction at 0x2EA6 in the disassembly above encodes to <code>D8 F0 08 E8</code> while another BLX instruction at 0x30C4 encodes to <code>8E F3 C4 E9</code>. The encoded instruction itself is divided into two 16-bit halves, each of which is shown in little-endian. The actual encodings are therefore F0 D8 E8 08 and F3 8E E9 C4. The encoding is explained in the THUMB instruction set (available <a href="https://ece.uwaterloo.ca/%7Eece222/ARM/ARM7-TDMI-manual-pt3.pdf">here</a>).</p>

<p>
<style type="text/css">
.pic {
    display: inline-block;
    margin-left: auto;
    margin-right: 10%;
    /*height: 30px;*/
}

#images {
    text-align:center;
}
</style>
<div id="images">
<img class="pic" src="/public/images/blxasm1.png" /><img class="pic" src="/public/images/blxasm2.png" />
</div>
</p>

<h2>Calculating the offset</h2>

<p>The instruction at 0x2EA6 branches to <code>_obj_msgSend</code>, which is at 0xDAEB8. The offset for encoding is calculated from the current value of PC which is 4 bytes ahead due to pipeline, i.e. 0x2EAA. When the target of branch is 32-bit ARM code, the value used is align(PC, 4), which is PC rounded down to align it to 4 bytes, i.e. PC &amp; 0xFFFFFFFC (0x2EA8 in this case). The offset is therefore, 0xDAEB8 - 0x2EA8 = 0xD8010.<br/></p>

<h2>Encoding the instruction</h2>

<p>The offset is then used to encode the instruction as follows:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">Offset</span> <span class="o">=</span> 0xD8010
 
      <span class="m">00</span>            0D            <span class="m">80</span>            10
 
Bits 31-24         23-16         15-8           7-0
   <span class="m">0000</span> <span class="m">0000</span>     <span class="m">0000</span> <span class="m">1101</span>     <span class="m">1000</span> <span class="m">0000</span>     <span class="m">0001</span> 0000
 
Bits 31-25      <span class="m">24</span> <span class="m">23</span> <span class="m">22</span>       21-12          11-2         10
     <span class="m">0000000</span>     <span class="m">0</span>  <span class="m">0</span>  <span class="m">0</span>     <span class="m">0011011000</span>     <span class="m">0000000100</span>     00
                 S I1  I2         H              L
 
<span class="nv">J1</span> <span class="o">=</span> ~I1 ^ <span class="nv">S</span> <span class="o">=</span> 1
<span class="nv">J2</span> <span class="o">=</span> ~I2 ^ <span class="nv">S</span> <span class="o">=</span> 1
 
Encoded instruction:
 
Bits 32-28    <span class="m">27</span>       26-17      16-15 <span class="m">14</span> <span class="m">13</span> <span class="m">12</span>     11-1          0
               S          H             J1    J2        L
     <span class="m">11110</span>     <span class="m">0</span>     <span class="m">0011011000</span>     <span class="m">11</span>  <span class="m">1</span>  <span class="m">0</span>  <span class="m">1</span>     <span class="m">0000000100</span>     0
 
      <span class="m">1111</span> <span class="m">0000</span>     <span class="m">1101</span> <span class="m">1000</span>     <span class="m">1110</span> <span class="m">1000</span>     <span class="m">0000</span> 1000
 
         F0            D8             E8           08</code></pre></div>

<p>which explains the encoding seen in the disassembler <code>(D8 F0 08 E8)</code>. :-)</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page3">Older</a>
  
  
    
      <a class="pagination-item newer" href="/">Newer</a>
    
  
</div>
    </div>

  </body>
</html>
