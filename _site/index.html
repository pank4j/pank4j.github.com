<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      CodePwn &middot; Stuff about Security
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/pic.png">
                                 <link rel="shortcut icon" href="/public/pic.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <link rel="stylesheet" href="/public/css/highlight/styles/monokai.css">
  <script src="/public/css/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          CodePwn
        </a>
      </h1>
      <p class="lead">Stuff about Security</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive.html">Archive</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/pank4j">GitHub</a>
    </nav>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/converting-ida-pro-graphs-to-images">
        Converting IDA Pro graphs to images
      </a>
    </h1>

    <span class="post-date">16 May 2015</span>

    <p>It&#39;s been a long time since my last post. I have been busy with work, and (thanks to IPR) could not post anything. This post is about a much needed feature in IDA Pro (specifically the wingraph32 utility), saving the graph as an image.</p>

<p>IDA Pro provides an interesting feature to view the disassembly of a function as a flowchart. The flowchart shows the function in the form of a control flow graph, where each node in the graph represents a basic block and each edge represents a control transfer. In many instances, one would like to export it as an image. However, the wingraph32 utility does not provide such an option.</p>

<p><center>
<img src="/public/images/wingraph32.png" alt="wingraph32" title="A graph as shown by wingraph32">
</center></p>

<p>The graph can be exported from IDA Pro (or from wingraoh32) as a .gdl (graph description language) file. The .gdl file can be converted into an image (or many other formats) using the <a href="http://search.cpan.org/dist/Graph-Easy/bin/graph-easy">Graph::Easy</a> CPAN module.</p>

<p>First install the Graph::Easy CPAN module. It requires <a href="http://www.graphviz.org/">Graphviz</a> to run, so install that as well.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">cpan Graph::Easy</code></pre></div>

<p>Then, convert the .gdl file to an image.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">graph-easy --from gdl --input<span class="o">=</span>graph.gdl --png --output<span class="o">=</span>graph.png</code></pre></div>

<p>This is how the final image of the above graph looks like.
<center>
<img src="/public/images/graph.png" alt="wingraph32" title="Graph converted by graph_easy">
</center></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/appminder-jailbreak-detection-analysis">
        AppMinder jailbreak detection analysis
      </a>
    </h1>

    <span class="post-date">28 Dec 2013</span>

    <p>Neso Lab&#39;s <a href="http://appminder.nesolabs.de/">AppMinder</a> project is another attempt at providing jailbreak detection for enterprise iOS applications (and perhaps AppStore apps). It provides three variants of jailbreak detections codes, each with an increasing level of self integrity checks and code obfuscation, and optionally including anti-debugging checks. It generates a piece of code with a function containing inline assembly code which can be inserted into the app&#39;s source code and called where jailbreak detection needs to be implemented. The generated code is metamorphic with a random function name. Metamorphism is achieved by a combination of register interchanges, instruction reordering, inserting dead code such as unused <code>push</code>, <code>pop</code> and <code>cmp</code> instructions.</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#if !(TARGET_IPHONE_SIMULATOR)</span>
<span class="n">__attribute__</span> <span class="p">((</span><span class="n">always_inline</span><span class="p">))</span> <span class="k">static</span> <span class="kt">void</span>
<span class="n">FsNZKlEjkXtDxShPvqbttYCo</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;mov r0, r0;mov r2, #152;sub r0, r2, #121;sub r1, r1;mov r2, #1;sub r2, #1;sub r3, r3;mov r4, #23;add r12, r4, #3;svc 0x80;mov r0, #76;mov r1, #2;b #2;push {r0-r12};mov r12, r1;b #2;pop {r0-r15};sub r1, r1, r1;b #1;cmp r0, r10;mov r0, r1;svc 0x80;cmp r0, #1;b #2;stmdb sp!, {r0-r12};bne #1;b #8;mov r0, #1;mov r12, #1;svc 0x80;mov r2, #12;sub r2, r2, r0;add r2, pc;bx r2;mov r0, #1;mov r12, #1;svc 0x80;b #1;cmp r0, r10;mov r1, r1;sub r1, r1, r1;b #2;push {r0-r12};mov r0, r1;mov r12, #256;asr r12, #7;b #1;cmp r0, r10;mov r1, #29;mov r0, r1;b #2;stmdb sp!, {r0-r12};svc 0x80;mov r2, r2;sub r1, r1, r1;mov r1, r1;mov r3, r1;add r3, r3, #1;cmp r0, r3;mov r2, r2;beq #8;mov r0, #1;mov r12, #1;svc 0x80;mov r1, r0;add r0, r0, #3;add r0, pc;mov pc, r0;pop {r0-r15};mov r0, r1;mov r0, r0;mov r3, #34;sub r0, r3, #3;sub r2, r2;mov r1, r2;sub r2, r2;sub r12, r12;mov r3, r12;mov r4, #193;sub r12, r4, #167;svc 0x80;b #2;pop {r0-r15};&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r0&quot;</span><span class="p">,</span> <span class="s">&quot;r1&quot;</span><span class="p">,</span> <span class="s">&quot;r2&quot;</span><span class="p">,</span> <span class="s">&quot;r3&quot;</span><span class="p">,</span> <span class="s">&quot;r4&quot;</span><span class="p">,</span> <span class="s">&quot;r12&quot;</span><span class="p">,</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span></code></pre></div>

<p>The code can be made a little more readable using <code>cat jbdetect.c | tr &#39;;&#39; &#39;\n&#39;</code>.</p>

<p>The code makes use of <code>svc 0x80</code> instruction throughout to invoke system calls. <code>svc 0x80</code> is the ARM counterpart of Intel&#39;s <code>int 0x80</code> instruction, used to invoke system calls. In iOS, which is a derivative of Darwin, the system call number is passed in r12 and the arguments in r0-r3. The return value is optionally returned in r0. <code>svc</code> also goes by the name of <code>swi</code> or <em>software interrupt</em>.</p>

<h2>Debugger detection</h2>

<p>Process tracing utilities and debuggers make use of <code>ptrace</code> system call to trace a running process. If the &#39;Anti-debugging option&#39; was selected, the code tries to detect and deny any debugging attempts. It does this by invoking <code>ptrace</code> (system call 26) on the current process with an argument of 31, i.e. <code>PTRACE_DENY_ATTACH</code>. Quoting from the man page:</p>

<p><img src="/public/images/ptrace.png" alt="ptrace"></p>

<p>The process is killed if a debugger is detected. Additionally, debuggers are denied to trace the process in any future requests. gdb shows a &quot;Operation not permitted&quot; message if it tries to attach to a process which has called <code>ptrace</code> with <code>PT_DENY_ATTACH</code>.</p>

<p>A complete list of system calls can be found in <a href="http://www.opensource.apple.com/source/xnu/xnu-1228.5.20/bsd/sys/syscall.h">sys/syscall.h</a>.</p>

<h2>Jailbreak Detection</h2>

<p>The code detects jailbreaks using <code>fork</code>. On non-jailbroken iOS, the sandbox restricts the use of <code>fork</code>. Calling <code>fork</code> fails with a return value of 1. However, on a jailbroken iOS, <code>fork</code> succeeds and spawns a new process. The code terminates the process using <code>exit(1)</code> if <code>fork</code> does not return 1.</p>

<p></p>

<p>The code does not do anything new, and does not even conceal its presence. It can be easily identified in memory by simply looking for <code>svc 0x80</code> instructions, which assemble to <code>80 00 00 EF</code>. Given the fact that jailbreak detection is inherently self defeating, it becomes trivial to bypass the above checks.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>
    </div>

  </body>
</html>
