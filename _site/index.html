<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      CodePwn &middot; Stuff about Security
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/pic.png">
                                 <link rel="shortcut icon" href="/public/pic.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <link rel="stylesheet" href="/public/css/highlight/styles/monokai.css">
  <script src="/public/css/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          CodePwn
        </a>
      </h1>
      <p class="lead">Stuff about Security</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive.html">Archive</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/pank4j">GitHub</a>
    </nav>

    <p>&copy; 2014. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/appminder-jailbreak-detection-analysis">
        AppMinder jailbreak detection analysis
      </a>
    </h1>

    <span class="post-date">28 Dec 2013</span>

    <p>Neso Lab&#39;s <a href="http://appminder.nesolabs.de/">AppMinder</a> project is another attempt at providing jailbreak detection for enterprise iOS applications (and perhaps AppStore apps). It provides three variants of jailbreak detections codes, each with an increasing level of self integrity checks and code obfuscation, and optionally including anti-debugging checks. It generates a piece of code with a function containing inline assembly code which can be inserted into the app&#39;s source code and called where jailbreak detection needs to be implemented. The generated code is metamorphic with a random function name. Metamorphism is achieved by a combination of register interchanges, instruction reordering, inserting dead code such as unused <code>push</code>, <code>pop</code> and <code>cmp</code> instructions.</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#if !(TARGET_IPHONE_SIMULATOR)</span>
<span class="n">__attribute__</span> <span class="p">((</span><span class="n">always_inline</span><span class="p">))</span> <span class="k">static</span> <span class="kt">void</span>
<span class="n">FsNZKlEjkXtDxShPvqbttYCo</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;mov r0, r0;mov r2, #152;sub r0, r2, #121;sub r1, r1;mov r2, #1;sub r2, #1;sub r3, r3;mov r4, #23;add r12, r4, #3;svc 0x80;mov r0, #76;mov r1, #2;b #2;push {r0-r12};mov r12, r1;b #2;pop {r0-r15};sub r1, r1, r1;b #1;cmp r0, r10;mov r0, r1;svc 0x80;cmp r0, #1;b #2;stmdb sp!, {r0-r12};bne #1;b #8;mov r0, #1;mov r12, #1;svc 0x80;mov r2, #12;sub r2, r2, r0;add r2, pc;bx r2;mov r0, #1;mov r12, #1;svc 0x80;b #1;cmp r0, r10;mov r1, r1;sub r1, r1, r1;b #2;push {r0-r12};mov r0, r1;mov r12, #256;asr r12, #7;b #1;cmp r0, r10;mov r1, #29;mov r0, r1;b #2;stmdb sp!, {r0-r12};svc 0x80;mov r2, r2;sub r1, r1, r1;mov r1, r1;mov r3, r1;add r3, r3, #1;cmp r0, r3;mov r2, r2;beq #8;mov r0, #1;mov r12, #1;svc 0x80;mov r1, r0;add r0, r0, #3;add r0, pc;mov pc, r0;pop {r0-r15};mov r0, r1;mov r0, r0;mov r3, #34;sub r0, r3, #3;sub r2, r2;mov r1, r2;sub r2, r2;sub r12, r12;mov r3, r12;mov r4, #193;sub r12, r4, #167;svc 0x80;b #2;pop {r0-r15};&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r0&quot;</span><span class="p">,</span> <span class="s">&quot;r1&quot;</span><span class="p">,</span> <span class="s">&quot;r2&quot;</span><span class="p">,</span> <span class="s">&quot;r3&quot;</span><span class="p">,</span> <span class="s">&quot;r4&quot;</span><span class="p">,</span> <span class="s">&quot;r12&quot;</span><span class="p">,</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span></code></pre></div>

<p>The code can be made a little more readable using <code>cat jbdetect.c | tr &#39;;&#39; &#39;\n&#39;</code>.</p>

<p>The code makes use of <code>svc 0x80</code> instruction throughout to invoke system calls. <code>svc 0x80</code> is the ARM counterpart of Intel&#39;s <code>int 0x80</code> instruction, used to invoke system calls. In iOS, which is a derivative of Darwin, the system call number is passed in r12 and the arguments in r0-r3. The return value is optionally returned in r0. <code>svc</code> also goes by the name of <code>swi</code> or <em>software interrupt</em>.</p>

<h2>Debugger detection</h2>

<p>Process tracing utilities and debuggers make use of <code>ptrace</code> system call to trace a running process. If the &#39;Anti-debugging option&#39; was selected, the code tries to detect and deny any debugging attempts. It does this by invoking <code>ptrace</code> (system call 26) on the current process with an argument of 31, i.e. <code>PTRACE_DENY_ATTACH</code>. Quoting from the man page:</p>

<p><img src="/public/images/ptrace.png" alt="ptrace"></p>

<p>The process is killed if a debugger is detected. Additionally, debuggers are denied to trace the process in any future requests. gdb shows a &quot;Operation not permitted&quot; message if it tries to attach to a process which has called <code>ptrace</code> with <code>PT_DENY_ATTACH</code>.</p>

<p>A complete list of system calls can be found in <a href="http://www.opensource.apple.com/source/xnu/xnu-1228.5.20/bsd/sys/syscall.h">sys/syscall.h</a>.</p>

<h2>Jailbreak Detection</h2>

<p>The code detects jailbreaks using <code>fork</code>. On non-jailbroken iOS, the sandbox restricts the use of <code>fork</code>. Calling <code>fork</code> fails with a return value of 1. However, on a jailbroken iOS, <code>fork</code> succeeds and spawns a new process. The code terminates the process using <code>exit(1)</code> if <code>fork</code> does not return 1.</p>

<p></p>

<p>The code does not do anything new, and does not even conceal its presence. It can be easily identified in memory by simply looking for <code>svc 0x80</code> instructions, which assemble to <code>80 00 00 EF</code>. Given the fact that jailbreak detection is inherently self defeating, it becomes trivial to bypass the above checks.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/dirty-harry-hacking-for-free-drinks-in-singapore">
        Dirty Harry: Hacking for free drinks in Singapore
      </a>
    </h1>

    <span class="post-date">04 Nov 2013</span>

    <p><a href="http://harrys.com.sg/">Harry&#39;s bar</a> is one of the most popular bar chains in Singapore. It has an iOS app &quot;Appy Hour&quot; that lets users spin the Harry&#39;s &quot;wheel of fortune&quot; to win free drinks. The way it works is that a user would visit one of their strategically located bars and check in using the app. He would then spin the wheel, and if he is lucky, he would win a free drink. A time limit is imposed so that a user can spin the wheel only once in 24 hours while signed in a particular bar.</p>

<p>Now there may not be any such thing as a free lunch, but there are free drinks! Let&#39;s see how.</p>

<p><center><img src="/public/images/win240x360.png" /></center>
<p></p></p>

<h2>The &#39;luck factor&#39;</h2>

<p>The app communicates with <code>www.exhost.se</code> over HTTP. When started, the first thing the app does is to define the &quot;luck factor&quot; of the user, by downloading an XML file containing probabilities of various prizes. The probabilities are set in way such that 52% of the time a spin would yield &#39;Better Luck Next Time&#39;.</p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/harrys_1_1_beta/venues.xml</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">www.exhost.se</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Appy Hour 1.1.0 (iPhone; iPhone OS 6.0.1; en_SG)</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip</span>

HTTP/1.1 200 OK
Age: 1659
Connection: Keep-Alive
Content-Length: 3071
Content-Type: application/xml
Date: Fri, 01 Nov 2013 06:27:45 GMT
ETag: &quot;3c8066-bff-4d7ddfaa98300&quot;
Last-Modified: Thu, 14 Mar 2013 08:05:00 GMT
Server: Apache/2.2.22 (Unix) mod_ssl/2.2.22 OpenSSL/0.9.8e-fips-rhel5 DAV/2 mod_bwlimited/1.4 mod_fcgid/2.3.6
Via: 1.1 qt-mfc4:80
 
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;Prizes&gt;
&lt;Prize&gt;
&lt;Description&gt;Better Luck*Next Time&lt;/Description&gt;
&lt;Units&gt;1&lt;/Units&gt;
&lt;ID&gt;1&lt;/ID&gt;
&lt;Active&gt;1&lt;/Active&gt;
&lt;Possibility&gt;13&lt;/Possibility&gt;
&lt;IsPrize&gt;0&lt;/IsPrize&gt;
&lt;PrizeFile&gt;img/1.png&lt;/PrizeFile&gt;
&lt;/Prize&gt;
&lt;Prize&gt;
&lt;Description&gt;1-for-1 Bacardi*Sup Gls&lt;/Description&gt;
&lt;Units&gt;1&lt;/Units&gt;
&lt;ID&gt;2&lt;/ID&gt;
&lt;Active&gt;1&lt;/Active&gt;
&lt;Possibility&gt;5&lt;/Possibility&gt;
&lt;IsPrize&gt;1&lt;/IsPrize&gt;
&lt;PrizeFile&gt;img/2.png&lt;/PrizeFile&gt;
&lt;/Prize&gt;
--snipped--</code></pre></div>

<h2>Time Restriction</h2>

<p>Once the user has checked in the bar, the app checks if the user has already tried his luck in the past 24 hours in the same bar. It does so by sending a request with the iPhone&#39;s UDID, a timestamp and the bar&#39;s id. The response simply consists of <code>true</code> if the user is allowed to spin the wheel, or <code>false</code> otherwise.</p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/harrys_1_1_beta/fetchdata.php?udid=aba5372762118af8f6f0594f836cd0eb32d10986&amp;time=2013-01-11%02:56:15&amp;venue=30</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">www.exhost.se</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Appy Hour 1.1.0 (iPhone; iPhone OS 6.0.1; en_SG)</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip</span>

HTTP/1.1 200 OK
Date: Fri, 01 Nov 2013 06:56:16 GMT
Server: Apache/2.2.22 (Unix) mod_ssl/2.2.22 OpenSSL/0.9.8e-fips-rhel5 DAV/2 mod_bwlimited/1.4 mod_fcgid/2.3.6
X-Powered-By: PHP/5.3.10
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Transfer-Encoding: chunked
Content-Type: text/html

true</code></pre></div>

<h2>Getting past everything</h2>

<p>Well, the simplest way to get past everything would be to make the app communicate with another server instead of <code>www.exhost.se</code>. First we will crawl <code>www.exhost.se</code> to get all the required files. The link <code>http://www.exhost.se/harrys_1_1_beta/</code> does not contain a default <code>index.html</code> or similar file, which makes crawling possible.</p>

<p><img src="/public/images/wget-harrys.png" alt="wget">
<img src="/public/images/strings-harrys.png" alt="strings"></p>

<p>Once we have the crawled files, we can edit the <code>venues.xml</code> file to change the probabilities. We can even change the drinks! ;-) Also, the file <code>fetchdata.php</code> should contain <code>true</code> for us to spin any number of times. Now these files can be hosted on a different server and these URLs can be changed in the app mach-o binary. Changing only the above two URLs is sufficient to make it work without any restrictions. The strings utility comes handy when trying to find out the location of these strings in the binary. These strings can now be edited using a hex editor. </p>

<p><img src="/public/images/strings.png" alt="Strings as seen in the disassembler after modification"></p>

<p>Once edited, we can run the app any number of times while signed in the same bar, and win a drink on every spin!</p>

<p>Cheers!</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>
    </div>

  </body>
</html>
