<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Assembling from scratch: Encoding BLX instruction in ARM / THUMB</title>

    <!--<link rel="stylesheet" href="https://github.com/themes/minimal/stylesheets/styles.css">-->
        <link rel="stylesheet" href="/js/libs/styles.css">
    <style>
      header { zoom: 1.2; }
      header h1 { margin-bottom: 5px; }
      header h1 a { color: #494949; font-weight: bold; }
      header h3 { margin-top: 20px; margin-bottom: 5px; }
      header p.view { margin-bottom: 5px; }
      header p.view small { padding-top: 2px; }
      header ul {
        zoom: 0.7;
        margin-top: 25px;
      }
      section p { margin-top: 10px; }
      section h1 { margin-bottom: 15px; }
      section h2 { margin-bottom: 10px; }
      section h2 { margin-bottom: 10px; }
      footer { bottom: 20px; }
      footer p { margin-bottom: 5px; }
      .half-width {
        float: left;
        width: 200px;
        list-style: none;
        padding: 5px;
        margin: 7px;
        margin-bottom: 10px;
      }
      .half-width h4 {
        margin-bottom: 5px;
      }
      .half-width ul {
        padding-left: 0;
      }
      .half-width ul li {
        list-style: inside;
        font-size: 15px;
      }
      .clear-fix {
        clear: both;
      }
    </style>
    <script src="https://github.com/themes/minimal/javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>
    <div class="wrapper">
      <header>
      <h1><a href="/">CodePwn</a></h1>
        <!-- <p>Where's Danish now?</p> -->

        <!-- <h3>The Goods</h3> -->
        <!-- <p class="view"><a href="/projects.html">Open Source Projects<small>Code that Might be Useful to You</small></a></p> -->
	<p class="view"><a href="/posts.html">Blog<small>My ramblings</small></a></p>
	<p class="view"><a href="/contact.html">Contact Me<small>Drop me a message</small></a></p>

        

        <h3>Follow Me On</h3>
        <p class="view"><a href="https://github.com/pank4j" target="tab">GitHub<small>If social coding is your thing</small></a></li>
        <p class="view"><a href="https://twitter.com/pank4j" target="tab">Twitter<small>If you tweet</small></a></li>

      </header>
      <section id="main">
        <article>
<h1>Assembling from scratch: Encoding BLX instruction in ARM / THUMB</h1>
<hr/>
<center><img src="/images/blx.png" /></center>


<p>If you have been working on x86 disassembly and moving on to ARM disassembly, one of the subtle differences you may notice is the lack of byte aligned opcodes in ARM (or THUMB) instruction set. Being based on RISC, ARM architecture provides fewer instructions as compared to x86. The need to implement an instruction set having functionally similar instructions as their x86 counterparts, only using fewer (and perhaps smaller) instructions gave rise to the instructions where opcodes are not dictated by bytes but by bits.</p>

<p>One of such intriguing instructions in ARM is BLX. BLX instruction performs a PC relative unconditional branch, and optionally changes mode to ARM or THUMB depending on the target address. It encodes to a 32-bit word under THUMB mode 2. It's encoding varies depending upon the relative offset between the instruction and the target address. For e.g. the instruction at 0x2EA6 in the disassembly above encodes to <code>D8 F0 08 E8</code> while another BLX instruction at 0x30C4 encodes to <code>8E F3 C4 E9</code>. The encoded instruction itself is divided into two 16-bit halves, each of which is shown in little-endian. The actual encodings are therefore F0 D8 E8 08 and F3 8E E9 C4. The encoding is explained in the THUMB instruction set (available <a href="https://ece.uwaterloo.ca/~ece222/ARM/ARM7-TDMI-manual-pt3.pdf">here</a>).</p>

<center><img src="/images/blxasm1.png" />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <img src="/images/blxasm2.png" /></center>


<h2>Calculating the offset</h2>

<p>The instruction at 0x2EA6 branches to <code>_obj_msgSend</code>, which is at 0xDAEB8. The offset for encoding is calculated from the current value of PC which is 4 bytes ahead due to pipeline, i.e. 0x2EAA. When the target of branch is 32-bit ARM code, the value used is align(PC, 4), which is PC rounded down to align it to 4 bytes, i.e. PC &amp; 0xFFFFFFFC (0x2EA8 in this case). The offset is therefore, 0xDAEB8 - 0x2EA8 = 0xD8010.<br/></p>

<h2>Encoding the instruction</h2>

<p>The offset is then used to encode the instruction as follows:</p>

<div class="highlight"><pre><code class="console"><span class="go">Offset = 0xD8010</span>

<span class="go">      00            0D            80            10</span>

<span class="go">Bits 31-24         23-16         15-8           7-0</span>
<span class="go">   0000 0000     0000 1101     1000 0000     0001 0000</span>

<span class="go">Bits 31-25      24 23 22       21-12          11-2         10</span>
<span class="go">     0000000     0  0  0     0011011000     0000000100     00</span>
<span class="go">                 S I1  I2         H              L</span>

<span class="go">J1 = ~I1 ^ S = 1</span>
<span class="go">J2 = ~I2 ^ S = 1</span>

<span class="go">Encoded instruction:</span>

<span class="go">Bits 32-28    27       26-17      16-15 14 13 12     11-1          0</span>
<span class="go">               S          H             J1    J2        L</span>
<span class="go">     11110     0     0011011000     11  1  0  1     0000000100     0</span>

<span class="go">      1111 0000     1101 1000     1110 1000     0000 1000</span>

<span class="go">         F0            D8             E8           08</span>
</code></pre></div>


<p>which explains the encoding seen in the disassembler <code>(D8 F0 08 E8)</code>. :-)</p>

</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'codepwn'; // required: replace example with your forum shortname
    var disqus_identifier = '171 /?p=171';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>



      </section>
      <footer>
        <!-- <p>This is the site of Danish Khan</p> -->
        <p><small>Hosted on <a href="http://pages.github.com">GitHub Pages</a> &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
  </body>
</html>
