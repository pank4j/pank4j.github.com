<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>AppMinder jailbreak detection analysis</title>

    <!--<link rel="stylesheet" href="https://github.com/themes/minimal/stylesheets/styles.css">-->
        <link rel="stylesheet" href="/js/libs/styles.css">
    <style>
      header { zoom: 1.2; }
      header h1 { margin-bottom: 5px; }
      header h1 a { color: #494949; font-weight: bold; }
      header h3 { margin-top: 20px; margin-bottom: 5px; }
      header p.view { margin-bottom: 5px; }
      header p.view small { padding-top: 2px; }
      header ul {
        zoom: 0.7;
        margin-top: 25px;
      }
      section p { margin-top: 10px; }
      section h1 { margin-bottom: 15px; }
      section h2 { margin-bottom: 10px; }
      section h2 { margin-bottom: 10px; }
      footer { bottom: 20px; }
      footer p { margin-bottom: 5px; }
      .half-width {
        float: left;
        width: 200px;
        list-style: none;
        padding: 5px;
        margin: 7px;
        margin-bottom: 10px;
      }
      .half-width h4 {
        margin-bottom: 5px;
      }
      .half-width ul {
        padding-left: 0;
      }
      .half-width ul li {
        list-style: inside;
        font-size: 15px;
      }
      .clear-fix {
        clear: both;
      }
    </style>
    <script src="https://github.com/themes/minimal/javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>
    <div class="wrapper">
      <header>
      <h1><a href="/">CodePwn</a></h1>
        <!-- <p>Where's Danish now?</p> -->

        <!-- <h3>The Goods</h3> -->
        <!-- <p class="view"><a href="/projects.html">Open Source Projects<small>Code that Might be Useful to You</small></a></p> -->
	<p class="view"><a href="/posts.html">Blog<small>My ramblings</small></a></p>
	<p class="view"><a href="/contact.html">Contact Me<small>Drop me a message</small></a></p>

        

        <h3>Follow Me On</h3>
        <p class="view"><a href="https://github.com/pank4j" target="tab">GitHub<small>If social coding is your thing</small></a></li>
        <p class="view"><a href="https://twitter.com/pank4j" target="tab">Twitter<small>If you tweet</small></a></li>

      </header>
      <section id="main">
        <article>
<h1>AppMinder jailbreak detection analysis</h1>
<hr/>
<p>Neso Lab&rsquo;s <a href="http://appminder.nesolabs.de/">AppMinder</a> project is another attempt at providing jailbreak detection for enterprise iOS applications (and perhaps AppStore apps). It provides three variants of jailbreak detections codes, each with an increasing level of self integrity checks and code obfuscation, and optionally including anti-debugging checks. It generates a piece of code with a function containing inline assembly code which can be inserted into the app&rsquo;s source code and called where jailbreak detection needs to be implemented. The generated code is metamorphic with a random function name. Metamorphism is achieved by a combination of register interchanges, instruction reordering, inserting dead code such as unused <code>push</code>, <code>pop</code> and <code>cmp</code> instructions.</p>

<div class="highlight"><pre><code class="c"><span class="cp">#if !(TARGET_IPHONE_SIMULATOR)</span>
<span class="n">__attribute__</span> <span class="p">((</span><span class="n">always_inline</span><span class="p">))</span> <span class="k">static</span> <span class="kt">void</span>
<span class="n">FsNZKlEjkXtDxShPvqbttYCo</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;mov r0, r0;mov r2, #152;sub r0, r2, #121;sub r1, r1;mov r2, #1;sub r2, #1;sub r3, r3;mov r4, #23;add r12, r4, #3;svc 0x80;mov r0, #76;mov r1, #2;b #2;push {r0-r12};mov r12, r1;b #2;pop {r0-r15};sub r1, r1, r1;b #1;cmp r0, r10;mov r0, r1;svc 0x80;cmp r0, #1;b #2;stmdb sp!, {r0-r12};bne #1;b #8;mov r0, #1;mov r12, #1;svc 0x80;mov r2, #12;sub r2, r2, r0;add r2, pc;bx r2;mov r0, #1;mov r12, #1;svc 0x80;b #1;cmp r0, r10;mov r1, r1;sub r1, r1, r1;b #2;push {r0-r12};mov r0, r1;mov r12, #256;asr r12, #7;b #1;cmp r0, r10;mov r1, #29;mov r0, r1;b #2;stmdb sp!, {r0-r12};svc 0x80;mov r2, r2;sub r1, r1, r1;mov r1, r1;mov r3, r1;add r3, r3, #1;cmp r0, r3;mov r2, r2;beq #8;mov r0, #1;mov r12, #1;svc 0x80;mov r1, r0;add r0, r0, #3;add r0, pc;mov pc, r0;pop {r0-r15};mov r0, r1;mov r0, r0;mov r3, #34;sub r0, r3, #3;sub r2, r2;mov r1, r2;sub r2, r2;sub r12, r12;mov r3, r12;mov r4, #193;sub r12, r4, #167;svc 0x80;b #2;pop {r0-r15};&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r0&quot;</span><span class="p">,</span> <span class="s">&quot;r1&quot;</span><span class="p">,</span> <span class="s">&quot;r2&quot;</span><span class="p">,</span> <span class="s">&quot;r3&quot;</span><span class="p">,</span> <span class="s">&quot;r4&quot;</span><span class="p">,</span> <span class="s">&quot;r12&quot;</span><span class="p">,</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</code></pre></div>




<p></p>


<p>The code can be made a little more readable using <code>cat jbdetect.c | tr ';' '\n'</code>.</p>

<p>The code makes use of <code>svc 0x80</code> instruction throughout to invoke system calls. <code>svc 0x80</code> is the ARM counterpart of Intel&rsquo;s <code>int 0x80</code> instruction, used to invoke system calls. In iOS, which is a derivative of Darwin, the system call number is passed in r12 and the arguments in r0-r3. The return value is optionally returned in r0. <code>svc</code> also goes by the name of <code>swi</code> or <em>software interrupt</em>.</p>

<h2>Debugger detection</h2>

<p>Process tracing utilities and debuggers make use of <code>ptrace</code> system call to trace a running process. If the &lsquo;Anti-debugging option&rsquo; was selected, the code tries to detect and deny any debugging attempts. It does this by invoking <code>ptrace</code> (system call 26) on the current process with an argument of 31, i.e. <code>PTRACE_DENY_ATTACH</code>. Quoting from the man page:</p>

<div class="highlight"><pre><code class="console"><span class="go">PT_DENY_ATTACH</span>
<span class="go">               This request is the other operation used by the traced</span>
<span class="go">               process; it allows a process that is not currently being</span>
<span class="go">               traced to deny future traces by its parent.  All other</span>
<span class="go">               arguments are ignored.  If the process is currently being</span>
<span class="go">               traced, it will exit with the exit status of ENOTSUP; oth-</span>
<span class="go">               erwise, it sets a flag that denies future traces.  An</span>
<span class="go">               attempt by the parent to trace a process which has set this</span>
<span class="go">               flag will result in a segmentation violation in the parent.</span>
</code></pre></div>


<p>The process is killed if a debugger is detected. Additionally, debuggers are denied to trace the process in any future requests. gdb shows a &ldquo;Operation not permitted&rdquo; message if it tries to attach to a process which has called <code>ptrace</code> with <code>PT_DENY_ATTACH</code>.</p>

<p>A complete list of system calls can be found in <a href="http://www.opensource.apple.com/source/xnu/xnu-1228.5.20/bsd/sys/syscall.h">sys/syscall.h</a>.</p>

<h2>Jailbreak Detection</h2>

<p>The code detects jailbreaks using <code>fork</code>. On non-jailbroken iOS, the sandbox restricts the use of <code>fork</code>. Calling <code>fork</code> fails with a return value of 1. However, on a jailbroken iOS, <code>fork</code> succeeds and spawns a new process. The code terminates the process using <code>exit(1)</code> if <code>fork</code> does not return 1.</p>

<p></p>


<p>The code does not do anything new, and does not even conceal its presence. It can be easily identified in memory by simply looking for <code>svc 0x80</code> instructions, which assemble to <code>80 00 00 EF</code>. Given the fact that jailbreak detection is inherently self defeating, it becomes trivial to bypass the above checks.</p>

</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'codepwn'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>



      </section>
      <footer>
        <!-- <p>This is the site of Danish Khan</p> -->
        <p><small>Hosted on <a href="http://pages.github.com">GitHub Pages</a> &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
  </body>
</html>
